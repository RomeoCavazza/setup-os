#!/usr/bin/env bash
set -euo pipefail

export PATH="/run/wrappers/bin:/etc/profiles/per-user/${USER}/bin:/run/current-system/sw/bin:${HOME}/.local/bin:${PATH}"

HYPRCTL="${HYPRCTL:-/run/current-system/sw/bin/hyprctl}"
JQ="${JQ:-/etc/profiles/per-user/${USER}/bin/jq}"
[[ -x "$JQ" ]] || JQ="/run/current-system/sw/bin/jq"

STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/dw-global.state"
ON_SHADER="glass_all"
OFF_SHADER="dw_off"

state="on"
[[ -f "$STATE_FILE" ]] && state="$(cat "$STATE_FILE" 2>/dev/null || echo on)"

shader="$ON_SHADER"
[[ "$state" == "on" ]] || shader="$OFF_SHADER"

"$HYPRCTL" -j clients \
  | "$JQ" -r '.[] | select(.mapped==true and .address!=null) | .address' \
  | while read -r addr; do
      [[ -n "$addr" ]] || continue
      "$HYPRCTL" dispatch darkwindow:shade "address:${addr}" "$shader" >/dev/null 2>&1 || true
    done

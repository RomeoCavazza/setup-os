#!/usr/bin/env bash
set -euo pipefail

LOG="${XDG_CACHE_HOME:-$HOME/.cache}/dw-global.log"
STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/dw-global.state"

export PATH="/run/wrappers/bin:/etc/profiles/per-user/${USER}/bin:/run/current-system/sw/bin:${HOME}/.local/bin:${PATH}"

HYPRCTL="${HYPRCTL:-/run/current-system/sw/bin/hyprctl}"
JQ="${JQ:-/etc/profiles/per-user/${USER}/bin/jq}"
[[ -x "$JQ" ]] || JQ="/run/current-system/sw/bin/jq"

ON_SHADER="glass_all"
OFF_SHADER="dw_off"

{
  echo "---- $(date) dw-toggle-global START ----"
  echo "PATH=$PATH"
  echo "HYPRCTL=$HYPRCTL"
  echo "JQ=$JQ"
} >>"$LOG"

state="on"
[[ -f "$STATE_FILE" ]] && state="$(cat "$STATE_FILE" 2>/dev/null || echo on)"

if [[ "$state" == "on" ]]; then
  target="$OFF_SHADER"
  next="off"
  msg="DarkWindow: OFF"
else
  target="$ON_SHADER"
  next="on"
  msg="DarkWindow: ON"
fi

echo "state(before)=$state target=$target next=$next" >>"$LOG"

"$HYPRCTL" -j clients \
  | "$JQ" -r '.[] | select(.mapped==true and .address!=null) | .address' \
  | while read -r addr; do
      [[ -n "$addr" ]] || continue
      echo "apply $target to $addr" >>"$LOG"
      "$HYPRCTL" dispatch darkwindow:shade "address:${addr}" "$target" >>"$LOG" 2>&1 || true
    done

echo "$next" > "$STATE_FILE"
"$HYPRCTL" notify -1 1200 "00eaff" "$msg" >/dev/null 2>&1 || true
echo "---- $(date) dw-toggle-global END ----" >>"$LOG"

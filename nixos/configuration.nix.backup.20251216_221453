{ config, pkgs, ... }:

let
  # 1. Configuration VSCode optimisée pour le dév Python/CUDA
  myVscode = pkgs.vscode-with-extensions.override {
    vscode = pkgs.vscode;
    vscodeExtensions = with pkgs.vscode-extensions; [
      ms-python.python ms-toolsai.jupyter redhat.java vscjava.vscode-java-pack
      ms-dotnettools.csharp golang.go rust-lang.rust-analyzer ms-vscode.cpptools
      esbenp.prettier-vscode bmewburn.vscode-intelephense-client xdebug.php-debug sumneko.lua
      # Ajout pour le confort visuel des fichiers de config
      jnoortheen.nix-ide
    ];
  };

  # 2. L'environnement Python "God Tier"
  pythonEnv = pkgs.python311.withPackages (ps: with ps; [
    # Core Data Science
    jupyter notebook ipykernel numpy pandas matplotlib scipy
    
    # HPC & GPU
    numba
    tqdm
    
    # Web/API Stack
    fastapi uvicorn gunicorn httpx pydantic python-dotenv
    sqlalchemy alembic psycopg psycopg2 passlib python-jose slowapi limits
    ruff mypy types-requests types-python-dateutil
  ]);

in
{
  imports = [
    ./hardware-configuration.nix
    ./modules/databases.nix
    ./modules/tmpfiles.nix
    ./modules/ollama.nix
    ./modules/launcher.nix
    ./modules/starship.nix
    ./modules/nvidia-prime.nix
  ];

  nixpkgs.config.allowUnfree = true;

  # Optimisation du cache pour récupérer les binaires CUDA précompilés (gagne du temps)
  nix.settings = {
    experimental-features = [ "nix-command" "flakes" ];
    auto-optimise-store = true;
    substituters = [ "https://cache.nixos-cuda.org" "https://cuda-maintainers.cachix.org" ];
    trusted-public-keys = [ 
      "cache.nixos-cuda.org:74DUi4Ye579gUqzH4ziL9IyiJBlDpMRn9MBN8oNan9M="
      "cuda-maintainers.cachix.org-1:0dq3bujKpuEPMCX6U4WylrUDZ9JyUG0VpVZa7CNfq5E="
    ];
  };

  nix.gc = { automatic = true; dates = "daily"; options = "--delete-older-than 7d"; };
  services.journald.extraConfig = "SystemMaxUse=200M\nRuntimeMaxUse=100M";
  virtualisation.docker = { enable = true; autoPrune.enable = true; };

  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;
  boot.loader.systemd-boot.configurationLimit = 1;

  # Paramètres Kernel optimisés pour la stabilité GPU
  boot.kernelParams = [ 
    "nowatchdog" 
    "nmi_watchdog=0"
    "nvidia-drm.modeset=1"
    "nvidia-drm.fbdev=0"
    "pcie_aspm=off"
    "intel_iommu=on"
    "iommu=pt"
  ];

  hardware.enableRedistributableFirmware = true;
  hardware.firmware = [ pkgs.linux-firmware ];

  networking.hostName = "nixos";
  networking.networkmanager.enable = true;
  networking.hosts."127.0.0.1" = [ "dev.localhost" ];

  time.timeZone = "Europe/Paris";
  i18n.defaultLocale = "fr_FR.UTF-8";
  console.keyMap = "fr";

  users.users.tco = {
    isNormalUser = true;
    description  = "tco";
    extraGroups  = [ "networkmanager" "wheel" "video" "docker" ];
  };

  services.xserver.enable = true;
  services.xserver.xkb.layout = "fr";
  services.xserver.displayManager.gdm = { enable = true; wayland = true; };
  services.displayManager.defaultSession = "gnome";
  services.xserver.desktopManager.gnome.enable = true;

  programs.hyprland = { enable = true; xwayland.enable = true; };

  services.dbus.enable = true;
  security.polkit.enable = true;
  services.gnome.gnome-keyring.enable = true;

  xdg.portal = {
    enable = true;
    xdgOpenUsePortal = true;
    extraPortals = with pkgs; [ xdg-desktop-portal-hyprland xdg-desktop-portal-gtk ];
  };

  services.pipewire = {
    enable = true; alsa.enable = true; alsa.support32Bit = true; pulse.enable = true;
  };

  hardware.bluetooth.enable = true;
  services.blueman.enable = true;

  # Support OpenGL/Vulkan
  hardware.graphics = { 
    enable = true; 
    enable32Bit = true; 
  };

  environment.sessionVariables = {
    NIXOS_OZONE_WL = "1"; MOZ_ENABLE_WAYLAND = "1";
    OPENAI_BASE_URL = "http://127.0.0.1:11434/v1"; OPENAI_API_KEY  = "ollama";
    
    # 3. VARIABLES CRITIQUES POUR NUMBA / CUDA SUR NIXOS
    CUDA_HOME = "${pkgs.cudaPackages.cudatoolkit}";
    CUDA_PATH = "${pkgs.cudaPackages.cudatoolkit}";
    
    LD_LIBRARY_PATH = "${pkgs.linuxPackages.nvidia_x11}/lib:${pkgs.cudaPackages.cudatoolkit}/lib:${pkgs.cudaPackages.cudnn}/lib";
    
    # Force Numba à utiliser les drivers système
    NUMBA_CUDA_DRIVER = "${pkgs.linuxPackages.nvidia_x11}/lib/libcuda.so";
  };

  programs.firefox.enable = true;
  programs.zoxide.enable = true;
  programs.direnv.enable = true;

  # 4. Ajout des outils système HPC
  environment.systemPackages = with pkgs; [
    # Base Utils
    vim neovim git wget curl just fastfetch btop htop pciutils lshw nvtopPackages.nvidia
    yazi ripgrep fd fzf unzip zip
    hyprland foot waybar rofi-wayland wl-clipboard
    pavucontrol bluez jetbrains-mono gcc gnumake cmake
    
    # Dev & Languages
    nodejs_20 pnpm pythonEnv pipx poetry uv
    postgresql_17 dbeaver-bin jetbrains.idea-community myVscode ollama docker-compose

    # === HPC / CUDA TOOLS ===
    cudaPackages.cudatoolkit
    cudaPackages.cuda_nvcc
    cudaPackages.nsight_compute
    cudaPackages.nsight_systems
    linuxPackages.nvidia_x11
  ];

  environment.localBinInPath = true;
  fonts.packages = with pkgs; [ noto-fonts noto-fonts-emoji jetbrains-mono ];
  system.stateVersion = "24.05";
}

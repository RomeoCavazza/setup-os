#!/usr/bin/env bash
set -euo pipefail

# ---- Env safe (Hypr exec peut avoir un PATH minimal) ----
export PATH="/run/wrappers/bin:/etc/profiles/per-user/${USER}/bin:/run/current-system/sw/bin:${HOME}/.local/bin:${PATH}"

HYPRCTL="${HYPRCTL:-/run/current-system/sw/bin/hyprctl}"
JQ="${JQ:-/etc/profiles/per-user/${USER}/bin/jq}"
[[ -x "$JQ" ]] || JQ="/run/current-system/sw/bin/jq"

STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/dw-global.state"
LOCK_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/dw-daemon.lock"

ON_SHADER="glass_all"
OFF_SHADER="dw_off"

# ---- Single instance ----
exec 9>"$LOCK_FILE"
flock -n 9 || exit 0

get_state() {
  if [[ -f "$STATE_FILE" ]]; then
    cat "$STATE_FILE" 2>/dev/null || echo "on"
  else
    echo "on"
  fi
}

apply_addr() {
  local addr="$1"
  [[ -n "$addr" && "$addr" != "0x0" ]] || return 0

  local state shader
  state="$(get_state)"
  shader="$ON_SHADER"
  [[ "$state" == "on" ]] || shader="$OFF_SHADER"

  "$HYPRCTL" dispatch darkwindow:shade "address:${addr}" "$shader" >/dev/null 2>&1 || true
}

apply_all_mapped() {
  "$HYPRCTL" -j clients \
    | "$JQ" -r '.[] | select(.mapped==true and .address!=null) | .address' \
    | while read -r a; do
        apply_addr "$a"
      done
}

# ---- Socket discovery / wait ----
find_sock() {
  # prend le plus récent socket2 Hypr (marche même sans HYPRLAND_INSTANCE_SIGNATURE)
  ls -1t "${XDG_RUNTIME_DIR}/hypr/"*/.socket2.sock 2>/dev/null | head -n 1 || true
}

SOCK=""
for _ in $(seq 1 120); do  # ~60s
  SOCK="$(find_sock)"
  [[ -S "$SOCK" ]] && break
  sleep 0.5
done

# si on a toujours rien, on reste vivant mais on ré-essaie périodiquement
if [[ ! -S "${SOCK:-}" ]]; then
  while true; do
    sleep 2
    SOCK="$(find_sock)"
    [[ -S "$SOCK" ]] && break
  done
fi

# ---- Apply au démarrage (et re-apply court pour éviter les races) ----
apply_all_mapped
sleep 0.6
apply_all_mapped

# ---- Listen openwindow events ----
exec socat -u "UNIX-CONNECT:${SOCK}" - \
  | while IFS= read -r line; do
      case "$line" in
        openwindow\>*)
          payload="${line#openwindow>>}"
          addr="${payload%%,*}"
          ( sleep 0.1; apply_addr "0x$addr" ) &
          ;;
        *)
          :
          ;;
      esac
    done

#!/usr/bin/env bash
set -euo pipefail

APPIMAGE="$HOME/.local/bin/appimages/Cursor.AppImage"
if [ ! -f "$APPIMAGE" ]; then
  echo "Cursor.AppImage introuvable: $APPIMAGE" >&2
  exit 1
fi

# IMPORTANT NixOS: expose les libs systÃ¨me Nix au loader (dlopen)
export LD_LIBRARY_PATH="/run/current-system/sw/lib:${LD_LIBRARY_PATH:-}"
export NIX_LD_LIBRARY_PATH="/run/current-system/sw/lib:${NIX_LD_LIBRARY_PATH:-}"

# Force extraction
appimage-run "$APPIMAGE" --version >/dev/null 2>&1 || true

# Patch native-keymap: Debug -> Release
for NK in "$HOME"/.cache/appimage-run/*/usr/share/cursor/resources/app/node_modules/native-keymap/build; do
  [ -d "$NK/Release" ] || continue
  mkdir -p "$NK/Debug"
  if [ -f "$NK/Release/keymapping.node" ]; then
    ln -sf "$NK/Release/keymapping.node" "$NK/Debug/keymapping.node"
    ln -sf "$NK/Release/keymapping.node" "$NK/Debug/keymapping"
  fi
done

exec appimage-run "$APPIMAGE" "$@"
